# Stack-Converter Plugin Protocol Schema

**Document Version:** 1.2
**Schema Version:** `1.0` (Corresponds to `PluginSchemaVersion` in `pkg/converter/plugin/plugin.go`)
**Date:** [Current Date]
**Status:** Draft

## 1. Overview

This document specifies the contract for communication between the `stack-converter` tool (specifically, its `PluginRunner` component) and external plugins. Plugins allow users to extend `stack-converter`'s functionality by injecting custom processing logic at defined stages.

This protocol adheres to the design outlined in `proposal.md` (Section 9.5) and `api-contract.md` (Section 4). For guidance on plugin development, see `docs/plugin_dev_guide.md` (To Be Created).

**Note:** For direct use with validation tools, consider extracting the JSON Schema definitions from Sections 3 & 4 into separate `.json` files (e.g., `docs/schemas/plugin_input_v1.0.schema.json`).

## 2. Communication Protocol

- **Mechanism:** JSON over Standard I/O (stdio).
- **Flow:**
  1.  `stack-converter` (via `PluginRunner`) starts the plugin command specified in the configuration as a separate process.
  2.  `stack-converter` marshals a `PluginInput` object (see Section 3) into JSON format.
  3.  `stack-converter` writes the JSON string to the plugin process's standard input (`stdin`) and then closes the stdin pipe.
  4.  The plugin process reads the JSON object from its `stdin`.
  5.  The plugin performs its custom logic.
  6.  The plugin marshals a `PluginOutput` object (see Section 4) into JSON format.
  7.  The plugin writes the JSON string to its standard output (`stdout`) and then exits with code 0 for success.
  8.  `stack-converter` reads the plugin's `stdout` until EOF, unmarshals the JSON into a `PluginOutput` object, and checks for errors.
  9.  `stack-converter` captures any output from the plugin's standard error (`stderr`) for logging purposes.
  10. `stack-converter` checks the plugin process's exit code. A non-zero exit code indicates a critical execution failure.

## 3. Input Schema (`PluginInput`)

This JSON object is sent from `stack-converter` to the plugin's `stdin`.

```json
{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "StackConverter PluginInput",
  "description": "Data sent from stack-converter to a plugin's stdin.",
  "type": "object",
  "properties": {
    "$schemaVersion": {
      "description": "Version of the plugin protocol schema being used by stack-converter. Plugins MUST check this for compatibility. See Section 7 for versioning details.",
      "type": "string",
      "const": "1.0"
    },
    "stage": {
      "description": "The pipeline stage the plugin is running in.",
      "type": "string",
      "enum": [
        "preprocessor",
        "postprocessor",
        "formatter"
        // See pkg/converter/plugin/plugin.go PluginStage* constants
      ]
    },
    "filePath": {
      "description": "Relative path of the source file being processed (from the input directory root). Uses '/' separators.",
      "type": "string",
      "examples": ["src/main.go", "docs/README.md"]
    },
    "content": {
      "description": "Current content of the file. For 'preprocessor' and 'formatter' stages, this is the UTF-8 decoded source content. For 'postprocessor', this is the Markdown content generated by the template.",
      "type": "string"
    },
    "metadata": {
      "description": "Map containing metadata about the file. The structure aligns with the TemplateMetadata object documented in [docs/template_guide.md](./template_guide.md), but serialized to JSON-compatible types (e.g., time.Time as RFC3339 string). Includes modifications from previous plugins in the same stage.",
      "type": "object",
      "properties": {
        "FilePath": { "type": "string" },
        "FileName": { "type": "string" },
        "OutputPath": { "type": "string" },
        // "Content" is deliberately omitted here; use the top-level "content" field.
        "DetectedLanguage": { "type": "string" },
        "LanguageConfidence": { "type": "number", "format": "float" },
        "SizeBytes": { "type": "integer" },
        "ModTime": { "type": "string", "format": "date-time" },
        "ContentHash": { "type": "string" },
        "IsBinary": { "type": "boolean" },
        "IsLarge": { "type": "boolean" },
        "Truncated": { "type": "boolean" },
        "GitInfo": {
          "type": ["object", "null"],
          "properties": {
            "Commit": { "type": "string" },
            "Author": { "type": "string" },
            "AuthorEmail": { "type": "string" },
            "DateISO": { "type": "string", "format": "date-time" }
          }
        },
        "ExtractedComments": { "type": ["string", "null"] },
        "FrontMatter": { "type": "object", "additionalProperties": true }
        // Refer to docs/template_guide.md for the definitive list of metadata fields.
      },
      "required": [
        "FilePath",
        "FileName",
        "OutputPath",
        "DetectedLanguage",
        "LanguageConfidence",
        "SizeBytes",
        "ModTime",
        "ContentHash",
        "IsBinary",
        "IsLarge",
        "Truncated",
        "GitInfo",
        "ExtractedComments",
        "FrontMatter"
      ]
    },
    "config": {
      "description": "Plugin-specific configuration map, taken directly from the plugin's 'config' section in stack-converter.yaml.",
      "type": "object",
      "additionalProperties": true,
      "default": {}
    }
  },
  "required": [
    "$schemaVersion",
    "stage",
    "filePath",
    "content",
    "metadata",
    "config"
  ]
}
```

**Field Details:**

- `$schemaVersion` (string, required): Version identifier for this schema. See Section 7.
- `stage` (string, required): Execution stage (e.g., `"preprocessor"`).
- `filePath` (string, required): Relative source file path.
- `content` (string, required): Current file content (UTF-8).
- `metadata` (object, required): File metadata map. See [`docs/template_guide.md`](./template_guide.md).
- `config` (object, required): Plugin-specific config from `stack-converter.yaml`.

## 4. Output Schema (`PluginOutput`)

This JSON object is expected from the plugin's `stdout` upon successful completion (exit code 0).

```json
{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "StackConverter PluginOutput",
  "description": "Data sent from a plugin to stack-converter's stdout upon successful execution (exit code 0).",
  "type": "object",
  "properties": {
    "$schemaVersion": {
      "description": "Version of the plugin protocol schema the plugin adheres to. Stack-converter MUST check this for compatibility. See Section 7.",
      "type": "string",
      "const": "1.0"
    },
    "error": {
      "description": "Functional error reporting. Empty string \"\" indicates success. A non-empty string indicates a problem occurred during the plugin's logic; stack-converter MUST treat this as a file processing error.",
      "type": "string",
      "default": ""
    },
    "content": {
      "description": "Optional: Modified content (UTF-8). If provided and non-null, this replaces the file's content for subsequent processing stages. If null or omitted, the content remains unchanged.",
      "type": ["string", "null"]
    },
    "metadata": {
      "description": "Optional: A map of metadata keys/values to add or update. Stack-converter MUST merge this map onto the existing metadata; keys provided here overwrite existing keys. See [docs/template_guide.md](./template_guide.md) for standard metadata fields.",
      "type": ["object", "null"],
      "additionalProperties": true
    },
    "output": {
      "description": "Optional: Final output content (e.g., HTML). If provided by a 'formatter' stage plugin, stack-converter MUST use this as the final content for the output file, skipping subsequent templating and postprocessing.",
      "type": ["string", "null"]
    }
  },
  "required": ["$schemaVersion", "error"],
  "if": {
    "properties": { "error": { "const": "" } }
  },
  "then": {
    "description": "If error is empty (success), at least one of content, metadata, or output SHOULD be provided if the plugin intends to modify state, though an empty successful response is valid.",
    "properties": {}
  },
  "else": {
    "description": "If error is non-empty, other fields (content, metadata, output) are ignored by stack-converter.",
    "properties": {}
  }
}
```

**Field Details:**

- `$schemaVersion` (string, required): Schema version plugin adheres to. See Section 7.
- `error` (string, required): Must be `""` for success. Non-empty indicates plugin-reported error.
- `content` (string | null, optional): Modified content. Replaces current content if non-null.
- `metadata` (object | null, optional): Metadata updates. Merged with existing metadata (overwriting keys) if non-null.
- `output` (string | null, optional): Final output (only for `formatter` stage). Bypasses further processing if non-null.

## 5. Error Handling & Logging

- **Functional Errors:** Plugins **MUST** report internal logic errors via the `"error"` field in `PluginOutput` (Section 4) and exit with code 0.
- **Execution Errors:** Fatal errors preventing valid JSON output **MUST** result in a **non-zero exit code**.
- **Logging:** Use `stderr` for diagnostics. `stack-converter` captures `stderr` for its logs. **Do NOT write JSON to `stderr`**.

## 6. Examples

_(Examples 1-6 remain the same as version 1.1)_

### Example 1: `PluginInput` (Preprocessor)

```json
{
  "$schemaVersion": "1.0",
  "stage": "preprocessor",
  "filePath": "src/utils/helpers.go",
  "content": "package utils\n\n// TODO: Refactor this later\nfunc Helper() {\n\t// ...\n}\n",
  "metadata": {
    "FilePath": "src/utils/helpers.go",
    "FileName": "helpers.go",
    "OutputPath": "src/utils/helpers.md",
    "DetectedLanguage": "go",
    "LanguageConfidence": 0.98,
    "SizeBytes": 75,
    "ModTime": "2024-08-03T10:00:00Z",
    "ContentHash": "sha256:...",
    "IsBinary": false,
    "IsLarge": false,
    "Truncated": false,
    "GitInfo": null,
    "ExtractedComments": null,
    "FrontMatter": {}
  },
  "config": {
    "removePrefix": "// TODO:"
  }
}
```

### Example 2: `PluginOutput` (Preprocessor Success - Modified Content & Metadata)

```json
{
  "$schemaVersion": "1.0",
  "error": "",
  "content": "package utils\n\n// Refactor this later\nfunc Helper() {\n\t// ...\n}\n",
  "metadata": {
    "commentRemoved": true,
    "preprocessingStatus": "cleaned"
  },
  "output": null
}
```

### Example 3: `PluginOutput` (Postprocessor Success - Added Metadata Only)

```json
{
  "$schemaVersion": "1.0",
  "error": "",
  "content": null,
  "metadata": {
    "processedBy": "MyPostProcessor",
    "validationStatus": "passed"
  },
  "output": null
}
```

### Example 4: `PluginOutput` (Formatter Success - Replaced Output)

```json
{
  "$schemaVersion": "1.0",
  "error": "",
  "content": null,
  "metadata": null,
  "output": "<h1>Formatted Title</h1><p>Generated HTML content...</p>"
}
```

### Example 5: `PluginOutput` (Functional Error Reported)

```json
{
  "$schemaVersion": "1.0",
  "error": "Failed to parse custom syntax in input file at line 42.",
  "content": null,
  "metadata": null,
  "output": null
}
```

### Example 6: `PluginOutput` (Success - No Changes)

```json
{
  "$schemaVersion": "1.0",
  "error": "",
  "content": null,
  "metadata": {
    "lintingPassed": true
  },
  "output": null
}
```

## 7. Schema Versioning

- The `$schemaVersion` field identifies the version of this **protocol schema**.
- **Current Version:** `1.0`
- **Compatibility:**
  - `stack-converter` (v3.x corresponding to schema v1.0) expects plugins to return `$schemaVersion: "1.0"`. It will reject output with mismatched versions.
  - Plugins **must** check the `$schemaVersion` in the received `PluginInput`. If it's higher than the version the plugin was built for (e.g., `"2.0"` when plugin expects `"1.0"`), the plugin should ideally exit gracefully with an error (non-zero exit code or via the `"error"` field) indicating incompatibility.
  - Plugins **should** be robust against receiving _additional_, unknown fields in `PluginInput` (forward compatibility).
- **Changes:**
  - Non-breaking changes (e.g., adding optional fields to `PluginInput` or `PluginOutput`) may occur in minor versions of `stack-converter`. The `$schemaVersion` will remain `"1.0"`.
  - Breaking changes (e.g., removing required fields, changing data types) will require incrementing the `$schemaVersion` (e.g., to `"2.0"`) and will correspond to a new major release of `stack-converter`.
- Changes are documented in the main `CHANGELOG.md` for `stack-converter`.
