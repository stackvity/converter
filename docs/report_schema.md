# Stack-Converter JSON Report Schema

**Document Version:** 1.2
**Schema Version:** `1.0` (Corresponds to `ReportSchemaVersion` in `pkg/converter/constants.go`)
**Date:** [Current Date]
**Status:** Draft

## 1. Overview

This document specifies the JSON schema for the report generated by `stack-converter` when executed with the `--output-format json` command-line flag. This structured output format is designed primarily for machine consumption, enabling integration with CI/CD pipelines, automated testing frameworks, or other tools that need to parse the results of a documentation generation run.

This schema corresponds directly to the Go `converter.Report` struct defined in `pkg/converter/report.go` and described conceptually in `proposal.md` (Section 8.3) and `api-contract.md` (Section 3).

**Note for Consumers:** It is recommended to use a JSON Schema validator tool against this schema (`docs/report_schema.md` or a derived `.json` file) when parsing the output of `stack-converter --output-format json` to ensure compatibility and handle potential future schema changes gracefully.

## 2. Schema Definition (JSON Schema Draft 7)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "StackConverter JSON Report",
  "description": "Schema for the JSON output generated by stack-converter --output-format json.",
  "type": "object",
  "properties": {
    "summary": {
      "description": "Overall summary statistics for the conversion run.",
      "type": "object",
      "properties": {
        "inputPath": {
          "description": "Absolute path to the source input directory.",
          "type": "string"
        },
        "outputPath": {
          "description": "Absolute path to the destination output directory.",
          "type": "string"
        },
        "profileUsed": {
          "description": "Name of the configuration profile used for the run (if any). Null if no profile used.",
          "type": ["string", "null"]
        },
        "configFilePath": {
          "description": "Path to the configuration file used (if any). Null if no file used.",
          "type": ["string", "null"]
        },
        "totalFilesScanned": {
          "description": "Total number of files and directories encountered by the walker (before filtering).",
          "type": "integer",
          "minimum": 0
        },
        "processedCount": {
          "description": "Number of files successfully processed (generated .md output, including cache hits).",
          "type": "integer",
          "minimum": 0
        },
        "cachedCount": {
          "description": "Number of files served directly from the cache (subset of processedCount).",
          "type": "integer",
          "minimum": 0
        },
        "skippedCount": {
          "description": "Number of files intentionally skipped (ignored, binary, large, Git excluded).",
          "type": "integer",
          "minimum": 0
        },
        "warningCount": {
          "description": "Number of non-fatal warnings logged during processing (e.g., encoding issues, truncation). Note: This relies on counting specific log events and might not be exhaustive.",
          "type": "integer",
          "minimum": 0
        },
        "errorCount": {
          "description": "Number of files that failed processing (listed in the 'errors' array).",
          "type": "integer",
          "minimum": 0
        },
        "fatalError": {
          "description": "True if the run terminated prematurely due to a fatal error (e.g., config error, or processing error with 'onError: stop').",
          "type": "boolean"
        },
        "durationSeconds": {
          "description": "Total execution time for the run in seconds.",
          "type": "number",
          "format": "double",
          "minimum": 0.0
        },
        "cacheEnabled": {
          "description": "Whether caching was enabled (reads/writes attempted) for this run.",
          "type": "boolean"
        },
        "concurrency": {
          "description": "Number of parallel workers used (0 means auto-detected).",
          "type": "integer",
          "minimum": 0
        },
        "timestamp": {
          "description": "Timestamp when the report was generated (ISO 8601 / RFC3339 format).",
          "type": "string",
          "format": "date-time"
        },
        "schemaVersion": {
            "description": "Version of this report schema. See Section 4.",
            "type": "string",
            "const": "1.0"
        }
      },
      "required": [
        "inputPath", "outputPath", "totalFilesScanned", "processedCount",
        "cachedCount", "skippedCount", "warningCount", "errorCount",
        "fatalError", "durationSeconds", "cacheEnabled", "concurrency", "timestamp",
        "schemaVersion"
      ]
    },
    "processedFiles": {
      "description": "List of files successfully processed or retrieved from cache.",
      "type": "array",
      "items": {
        "$ref": "#/definitions/FileInfo"
      }
    },
    "skippedFiles": {
      "description": "List of files that were intentionally skipped.",
      "type": "array",
      "items": {
        "$ref": "#/definitions/SkippedInfo"
      }
    },
    "errors": {
      "description": "List of errors encountered during file processing (when 'onError: continue' or for fatal errors).",
      "type": "array",
      "items": {
        "$ref": "#/definitions/ErrorInfo"
      }
    }
  },
  "required": [
    "summary",
    "processedFiles",
    "skippedFiles",
    "errors"
  ],
  "definitions": {
    "FileInfo": {
      "description": "Details about a single file that was successfully processed or retrieved from cache.",
      "type": "object",
      "properties": {
        "path": {
          "description": "Relative path of the source file (from input root). Uses '/' separators.",
          "type": "string"
        },
        "outputPath": {
          "description": "Relative path of the generated output file (from output root). Uses '/' separators.",
          "type": "string"
        },
        "language": {
          "description": "Detected language identifier (e.g., 'go', 'python', 'plaintext').",
          "type": "string"
        },
        "languageConfidence": {
          "description": "Confidence score (0.0-1.0) for the language detection.",
          "type": "number",
          "format": "double",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "sizeBytes": {
          "description": "Size of the original source file in bytes.",
          "type": "integer",
          "minimum": 0
        },
        "modTime": {
          "description": "Last modification timestamp of the source file (ISO 8601 / RFC3339 format).",
          "type": "string",
          "format": "date-time"
        },
        "cacheStatus": {
          "description": "Cache status for this file.",
          "type": "string",
          "enum": ["hit", "miss", "disabled"]
        },
        "durationMs": {
          "description": "Time taken to process this specific file in milliseconds (0 for cache hits).",
          "type": "integer",
          "minimum": 0
        },
        "extractedComments": {
          "description": "True if documentation comments were successfully extracted.",
          "type": "boolean"
        },
        "frontMatter": {
          "description": "True if front matter was generated and prepended.",
          "type": "boolean"
        },
        "pluginsRun": {
          "description": "List of names of plugins that were executed for this file. Null if none.",
          "type": ["array", "null"],
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "path", "outputPath", "language", "languageConfidence", "sizeBytes",
        "modTime", "cacheStatus", "durationMs", "extractedComments", "frontMatter"
      ]
    },
    "SkippedInfo": {
      "description": "Details about a file that was intentionally skipped.",
      "type": "object",
      "properties": {
        "path": {
          "description": "Relative path of the skipped source file (from input root). Uses '/' separators.",
          "type": "string"
        },
        "reason": {
          "description": "Reason why the file was skipped.",
          "type": "string",
          "enum": [
            "binary_file",
            "large_file",
            "ignored_pattern",
            "excluded_by_git_diff"
            // See pkg/converter/constants.go for full list (e.g., SkipReason*)
          ]
        },
        "details": {
          "description": "Additional details about the skip reason (e.g., matched pattern, size threshold).",
          "type": "string"
        }
      },
      "required": [
        "path", "reason", "details"
      ]
    },
    "ErrorInfo": {
      "description": "Details about an error encountered while processing a specific file.",
      "type": "object",
      "properties": {
        "path": {
          "description": "Relative path of the source file where the error occurred (from input root). Uses '/' separators.",
          "type": "string"
        },
        "error": {
          "description": "Descriptive error message.",
          "type": "string"
        },
        "isFatal": {
          "description": "True if this specific error caused the entire run to stop ('onError: stop' mode).",
          "type": "boolean"
        }
      },
      "required": [
        "path", "error", "isFatal"
      ]
    }
  }
}
```

## 3. Example JSON Report (Enhanced)

This example demonstrates various scenarios, including cache hits/misses, skips, errors, and a fatal error condition (`fatalError: true`) indicating the run stopped prematurely due to `onError: stop` (the file lists might be incomplete in such a case).

```json
{
  "summary": {
    "inputPath": "/Users/alex/dev/failing-project/src",
    "outputPath": "/Users/alex/dev/failing-project/docs",
    "profileUsed": null,
    "configFilePath": "/Users/alex/dev/failing-project/stack-converter.yaml",
    "totalFilesScanned": 55,
    "processedCount": 10, // Files processed before fatal error
    "cachedCount": 8,    // Cache hits before fatal error
    "skippedCount": 2,   // Skips before fatal error
    "warningCount": 1,
    "errorCount": 1,    // The error that caused the stop
    "fatalError": true, // Run was halted due to onError: stop
    "durationSeconds": 1.256, // Duration until halt
    "cacheEnabled": true,
    "concurrency": 8,
    "timestamp": "2024-08-06T09:30:15Z",
    "schemaVersion": "1.0"
  },
  "processedFiles": [
    // Only files processed *before* the fatal error occurred
    {
      "path": "utils/helpers.py",
      "outputPath": "utils/helpers.py.md",
      "language": "python",
      "languageConfidence": 0.99,
      "sizeBytes": 1200,
      "modTime": "2024-08-05T10:00:00Z",
      "cacheStatus": "hit",
      "durationMs": 0,
      "extractedComments": false,
      "frontMatter": false,
      "pluginsRun": null
    }
    // ... (Potentially 9 more FileInfo objects)
  ],
  "skippedFiles": [
    // Only files skipped *before* the fatal error occurred
    {
      "path": "vendor/lib.js",
      "reason": "ignored_pattern",
      "details": "Matched pattern: vendor/"
    }
    // ... (Potentially 1 more SkippedInfo object)
  ],
  "errors": [
    // Includes the error that caused the halt
    {
      "path": "core/critical.go",
      "error": "plugin execution failed for 'validator-plugin': exit status 137",
      "isFatal": true // This error triggered the halt
    }
  ]
}
```

## 4. Schema Versioning

*   The `summary.schemaVersion` field identifies the version of this **report schema**.
*   **Current Version:** `1.0`
*   **Compatibility:** Consumers of this JSON report **should** check the `schemaVersion` field to ensure they can correctly interpret the structure.
*   **Changes:**
    *   Non-breaking changes (e.g., adding new optional fields to `summary`, `FileInfo`, `SkippedInfo`, or `ErrorInfo`) may occur in minor/patch versions of `stack-converter`. The `schemaVersion` will remain `"1.0"`. Consumers should be designed to ignore unknown fields.
    *   Breaking changes (e.g., removing required fields, changing data types, significantly restructuring the report) will require incrementing the `schemaVersion` (e.g., to `"2.0"`) and will correspond to a new major release of `stack-converter`.
*   Changes are documented in the main `CHANGELOG.md` for `stack-converter`.

